<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nobody's Perfect - Spieler</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="screen active">
            <div class="login-box">
                <h1>üéÆ Nobody's Perfect</h1>
                <p class="subtitle">Spiel mit deinem Team mit!</p>
                
                <div class="input-group">
                    <label for="teamName">Teamnamen:</label>
                    <input 
                        type="text" 
                        id="teamName" 
                        placeholder="z.B. Die Gewinner"
                        maxlength="20"
                    >
                </div>
                
                <button id="joinBtn" class="btn btn-primary">Spiel beitreten</button>
                <button id="hostBtn" class="btn btn-secondary">Zum Host-Panel</button>
            </div>
        </div>

        <!-- Waiting Lobby Screen -->
        <div id="waitingLobbyScreen" class="screen">
            <div class="lobby-container">
                <h1 style="font-size: 2.8em; margin-bottom: 5px;">‚è≥ Warten auf das Spiel</h1>
                <p style="font-size: 1.1em; color: #94a3b8; margin-bottom: 50px;">Der Host bereitet das Spiel vor...</p>
                
                <div class="waiting-teams-display">
                    <h3 style="font-size: 1.3em; margin-bottom: 20px;">Beigetretene Teams:</h3>
                    <div id="lobbyTeamsList" class="teams-grid">
                        <p class="empty-state">Teams werden geladen...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="screen">
            <!-- Header with Score -->
            <header class="game-header">
                <div class="team-info">
                    <h2 id="currentTeam"></h2>
                    <div class="score-display">
                        <span id="teamScore">0</span> Punkte
                    </div>
                </div>
                <button id="leaveBtn" class="btn btn-small">Verlassen</button>
            </header>

            <!-- Question Display -->
            <div class="question-section">
                <div id="questionArea" class="question-box">
                    <h3>Wartet auf Frage...</h3>
                </div>
            </div>

            <!-- Answer Input Section -->
            <div class="answer-section">
                <div id="answerForm" style="display: none;">
                    <h4>Deine Antwort:</h4>
                    <input 
                        type="text" 
                        id="answerInput" 
                        placeholder="Gib deine Antwort ein..."
                        maxlength="100"
                    >
                    <button id="submitAnswerBtn" class="btn btn-primary">Antwort einreichen</button>
                </div>
                <div id="answerSubmitted" style="display: none;" class="info-box">
                    ‚úì Deine Antwort wurde eingereicht
                </div>
            </div>

            <!-- Voting Section -->
            <div class="voting-section">
                <h4>Abstimmen:</h4>
                <div id="votingArea" class="voting-buttons">
                    <p class="empty-state">Warte auf Antworten zum Abstimmen...</p>
                </div>
            </div>

            <!-- Scoreboard -->
            <div class="scoreboard-section">
                <h4>Punktestand:</h4>
                <div id="scoreBoard" class="scoreboard">
                    <p class="empty-state">Keine Teams bisher...</p>
                </div>
            </div>
        </div>

        <!-- Transition Screen (Answer to Voting) -->
        <div id="transitionScreen" class="screen">
            <div class="transition-box">
                <h1>‚è∏Ô∏è Antwortphase beendet</h1>
                <p class="subtitle">Bereite dich auf die Abstimmung vor...</p>
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Leaderboard Screen -->
        <div id="leaderboardScreen" class="screen">
            <header class="game-header">
                <h1>üèÜ Rangliste</h1>
                <button id="leaveLeaderboardBtn" class="btn btn-small">Verlassen</button>
            </header>
            <div class="leaderboard-section">
                <div id="leaderboardDisplay" class="scoreboard">
                    <p class="empty-state">Lade Rangliste...</p>
                </div>
            </div>
        </div>

        <!-- Celebration Screen (Game End) -->
        <div id="celebrationScreen" class="screen">
            <div class="celebration-container">
                <h1 style="font-size: 3em; margin-bottom: 30px; animation: pulse 0.6s ease-in-out;">üéâ Spiel beendet! üéâ</h1>
                <div class="podium">
                    <!-- Silver (2nd place) -->
                    <div class="podium-slot silver">
                        <div class="medal">ü•à</div>
                        <h3 id="secondTeamName">Team</h3>
                        <p id="secondTeamScore">0</p>
                        <div class="place-label">2. Platz</div>
                    </div>
                    <!-- Gold (1st place) -->
                    <div class="podium-slot gold">
                        <div class="medal">ü•á</div>
                        <h3 id="firstTeamName">Team</h3>
                        <p id="firstTeamScore">0</p>
                        <div class="place-label">1. Platz</div>
                    </div>
                    <!-- Bronze (3rd place) -->
                    <div class="podium-slot bronze">
                        <div class="medal">ü•â</div>
                        <h3 id="thirdTeamName">Team</h3>
                        <p id="thirdTeamScore">0</p>
                        <div class="place-label">3. Platz</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .transition-box {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            box-shadow: var(--shadow);
            max-width: 600px;
            margin: 0 auto;
        }

        .transition-box h1 {
            color: var(--text-color);
            font-size: 48px;
            margin-bottom: 20px;
        }

        .transition-box .subtitle {
            color: var(--text-secondary);
            font-size: 20px;
            margin-bottom: 40px;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 40px;
        }

        .spinner {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, set, update, onValue, child, get, runTransaction } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC85YAPrSD3a4uw-bzTOWWAx18KBG4Enes",
            authDomain: "w-feier.firebaseapp.com",
            databaseURL: "https://w-feier-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "w-feier",
            storageBucket: "w-feier.firebasestorage.app",
            messagingSenderId: "319969590062",
            appId: "1:319969590062:web:7601a072a2429df53758bf",
            measurementId: "G-C7KVSD61MF"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let currentTeamName = null;
        let currentUser = null;
        let roundFinished = false;
        let currentQuestion = null;
        let teamVote = null; // Track which answer this team voted for
        let gamePhase = 'setup'; // Syncs with host: 'setup', 'answering', 'voting', 'finished'

        // Anonymous sign-in
        signInAnonymously(auth)
            .then(user => {
                currentUser = user;
                console.log("Authenticated as:", user.user.uid);
            })
            .catch(error => console.error("Auth error:", error));

        // Event Listeners
        document.getElementById('joinBtn').addEventListener('click', joinGame);
        document.getElementById('hostBtn').addEventListener('click', () => window.location.href = 'host.html');
        document.getElementById('leaveBtn').addEventListener('click', leaveGame);
        document.getElementById('submitAnswerBtn').addEventListener('click', submitAnswer);
        document.getElementById('leaveLeaderboardBtn').addEventListener('click', leaveGame);

        async function joinGame() {
            const teamName = document.getElementById('teamName').value.trim();
            if (!teamName) {
                alert('Bitte gib einen Teamnamen ein');
                return;
            }

            currentTeamName = teamName;

            // Create team in database
            await set(ref(db, `game/teams/${teamName}`), {
                name: teamName,
                joinedAt: new Date().toISOString()
            });

            // Initialize score if not exists
            const scoreRef = ref(db, `game/scores/${teamName}`);
            const snapshot = await get(scoreRef);
            if (!snapshot.exists()) {
                await set(scoreRef, 0);
            }

            showGameScreen();
            startListeners();
        }

        function updateVotingDisplay() {
            const votingArea = document.getElementById('votingArea');
            
            // Check if round is finished first
            if (!roundFinished || !currentQuestion) {
                votingArea.innerHTML = '<p class="empty-state">Warte auf Freigabe der Antworten...</p>';
                return;
            }
            
                    // Get the game seed first
                    get(ref(db, 'game/seed')).then(seedSnapshot => {
                        const gameSeed = seedSnapshot.val() || '';
                        // Get all answers from database
                        get(ref(db, 'game/answers')).then(snapshot => {
                            const allAnswers = snapshot.val();
                            // Check if team already voted
                            get(ref(db, `game/votes/${currentQuestion.id}/${currentTeamName}`)).then(voteSnapshot => {
                                teamVote = voteSnapshot.val();
                                if (allAnswers && allAnswers[currentQuestion.id]) {
                                    let votingHtml = '';
                                    const teamAnswers = allAnswers[currentQuestion.id];
                                    // Convert to array and filter out own answer
                                    let answerArr = Object.entries(teamAnswers).filter(([team]) => team !== currentTeamName);
                                    // Seeded shuffle: use game seed + team name + question id as seed
                                    function seededRandom(seed) {
                                        let x = Math.sin(seed) * 10000;
                                        return x - Math.floor(x);
                                    }
                                    function stringToSeed(str) {
                                        let hash = 0;
                                        for (let i = 0; i < str.length; i++) {
                                            hash = ((hash << 5) - hash) + str.charCodeAt(i);
                                            hash |= 0;
                                        }
                                        return Math.abs(hash);
                                    }
                                    function seededShuffle(array, seed) {
                                        let arr = array.slice();
                                        for (let i = arr.length - 1; i > 0; i--) {
                                            const j = Math.floor(seededRandom(seed + i) * (i + 1));
                                            [arr[i], arr[j]] = [arr[j], arr[i]];
                                        }
                                        return arr;
                                    }
                                    const seed = stringToSeed(gameSeed + '_' + currentTeamName + '_' + currentQuestion.id);
                                    answerArr = seededShuffle(answerArr, seed);
                                    answerArr.forEach(([team, answerData]) => {
                                        const isVoted = teamVote === team;
                                        const buttonClass = isVoted ? 'btn-vote-selected' : '';
                                        const checkmark = isVoted ? '‚úì ' : '';
                                        votingHtml += `
                                            <div class="voting-button">
                                                <button class="btn btn-vote ${buttonClass}" onclick="voteAnswer('${currentQuestion.id}', '${team}')" ${teamVote ? 'disabled' : ''}>
                                                    ${checkmark}${answerData.text}
                                                </button>
                                            </div>
                                        `;
                                    });
                                    votingArea.innerHTML = votingHtml || '<p class="empty-state">Nur deine Antwort verf√ºgbar</p>';
                                } else {
                                    votingArea.innerHTML = '<p class="empty-state">Warte auf Antworten zum Abstimmen...</p>';
                                }
                            });
                        });
                    });
        }

        function showGameScreen() {
            const loginScreen = document.getElementById('loginScreen');
            const gameScreen = document.getElementById('gameScreen');
            
            loginScreen.classList.remove('active');
            loginScreen.style.display = 'none';
            gameScreen.classList.add('active');
            gameScreen.style.display = 'block';
            document.getElementById('currentTeam').textContent = `Team: ${currentTeamName}`;
        }

        function startListeners() {
            // Listen for game phase
            onValue(ref(db, 'game/phase'), (snapshot) => {
                const newPhase = snapshot.val();
                if (newPhase !== gamePhase) {
                    gamePhase = newPhase;
                    console.log('üîÑ Game phase changed to:', gamePhase);
                    updateUIForPhase();
                }
            });

            // Listen for current question
            onValue(ref(db, 'game/currentQuestion'), (snapshot) => {
                currentQuestion = snapshot.val();
                const question = currentQuestion;
                const questionArea = document.getElementById('questionArea');
                
                // Reset vote for new question
                teamVote = null;
                
                if (question) {
                    questionArea.innerHTML = `<h3>${question.text}</h3>`;
                    
                    // Only show answer form during answering phase
                    if (gamePhase === 'answering') {
                        // Check if team already answered
                        const answerRef = ref(db, `game/answers/${question.id}/${currentTeamName}`);
                        get(answerRef).then(snap => {
                            if (snap.exists()) {
                                document.getElementById('answerForm').style.display = 'none';
                                document.getElementById('answerSubmitted').style.display = 'block';
                            } else {
                                document.getElementById('answerForm').style.display = 'block';
                                document.getElementById('answerSubmitted').style.display = 'none';
                            }
                        });
                    } else {
                        // During voting or other phases, never show the answer form
                        document.getElementById('answerForm').style.display = 'none';
                        document.getElementById('answerSubmitted').style.display = 'none';
                    }
                } else {
                    questionArea.innerHTML = '<h3>Wartet auf Frage...</h3>';
                    document.getElementById('answerForm').style.display = 'none';
                    document.getElementById('answerSubmitted').style.display = 'none';
                }
                
                // Update voting display when question changes
                updateVotingDisplay();
            });

            // Listen for answers (voting)
            onValue(ref(db, 'game/answers'), (snapshot) => {
                updateVotingDisplay();
            });
            
            // Listen for round finished state to trigger voting display update
            onValue(ref(db, 'game/roundFinished'), (snapshot) => {
                roundFinished = snapshot.val() || false;
                updateVotingDisplay();
            });

            // Listen for scores
            onValue(ref(db, 'game/scores'), (snapshot) => {
                const scores = snapshot.val();
                const scoreBoard = document.getElementById('scoreBoard');
                
                if (scores) {
                    const sortedTeams = Object.entries(scores)
                        .sort((a, b) => b[1] - a[1])
                        .map(([team, score]) => `
                            <div class="scoreboard-entry ${team === currentTeamName ? 'own-team' : ''}">
                                <span class="team-name">${team}</span>
                                <span class="team-score">${score}</span>
                            </div>
                        `).join('');
                    scoreBoard.innerHTML = sortedTeams;
                } else {
                    scoreBoard.innerHTML = '<p class="empty-state">Keine Teams bisher...</p>';
                }

                // Update own score
                if (scores && scores[currentTeamName]) {
                    document.getElementById('teamScore').textContent = scores[currentTeamName];
                }
            });

            // Listen for game phase
            onValue(ref(db, 'game/phase'), (snapshot) => {
                gamePhase = snapshot.val() || 'setup';
                updateUIForPhase();
            });

            // Listen for teams joining (for lobby display)
            onValue(ref(db, 'game/teams'), (snapshot) => {
                updateLobbyTeamsList();
            });
        }

        function updateUIForPhase() {
            const gameScreen = document.getElementById('gameScreen');
            const transitionScreen = document.getElementById('transitionScreen');
            const leaderboardScreen = document.getElementById('leaderboardScreen');
            const celebrationScreen = document.getElementById('celebrationScreen');
            const waitingLobbyScreen = document.getElementById('waitingLobbyScreen');
            const answerForm = document.getElementById('answerForm');
            const answerSubmitted = document.getElementById('answerSubmitted');
            const votingSection = document.querySelector('.voting-section');
            const submitBtn = document.getElementById('submitAnswerBtn');
            
            if (gamePhase === 'setup') {
                // Show waiting lobby screen
                gameScreen.style.display = 'none';
                transitionScreen.style.display = 'none';
                leaderboardScreen.style.display = 'none';
                celebrationScreen.style.display = 'none';
                waitingLobbyScreen.style.display = 'block';
                updateLobbyTeamsList();
            } else if (gamePhase === 'answering') {
                // Show game screen with answer section, hide voting and leaderboard
                gameScreen.style.display = 'block';
                transitionScreen.style.display = 'none';
                leaderboardScreen.style.display = 'none';
                celebrationScreen.style.display = 'none';
                waitingLobbyScreen.style.display = 'none';
                votingSection.style.display = 'none';
                answerForm.style.display = 'block';
                answerSubmitted.style.display = 'none';
                if (submitBtn) submitBtn.disabled = false;
            } else if (gamePhase === 'answering_finished') {
                // Show transition screen
                gameScreen.style.display = 'none';
                transitionScreen.style.display = 'block';
                leaderboardScreen.style.display = 'none';
                celebrationScreen.style.display = 'none';
                waitingLobbyScreen.style.display = 'none';
            } else if (gamePhase === 'voting') {
                // Show game screen with voting section, hide answer input
                gameScreen.style.display = 'block';
                transitionScreen.style.display = 'none';
                leaderboardScreen.style.display = 'none';
                celebrationScreen.style.display = 'none';
                waitingLobbyScreen.style.display = 'none';
                votingSection.style.display = 'block';
                answerForm.style.display = 'none';
                answerSubmitted.style.display = 'none';
                if (submitBtn) submitBtn.disabled = true;  // Disable answer submission
            } else if (gamePhase === 'results') {
                // Show leaderboard screen
                gameScreen.style.display = 'none';
                transitionScreen.style.display = 'none';
                leaderboardScreen.style.display = 'block';
                celebrationScreen.style.display = 'none';
                waitingLobbyScreen.style.display = 'none';
                updateLeaderboardDisplay();
            } else if (gamePhase === 'celebration') {
                // Show celebration screen
                gameScreen.style.display = 'none';
                transitionScreen.style.display = 'none';
                leaderboardScreen.style.display = 'none';
                celebrationScreen.style.display = 'block';
                waitingLobbyScreen.style.display = 'none';
                updateCelebrationScreen();
            } else {
                // Finished phase
                gameScreen.style.display = 'block';
                transitionScreen.style.display = 'none';
                leaderboardScreen.style.display = 'none';
                celebrationScreen.style.display = 'none';
                waitingLobbyScreen.style.display = 'none';
                votingSection.style.display = 'none';
                answerForm.style.display = 'none';
                if (submitBtn) submitBtn.disabled = true;
            }
        }

        function updateCelebrationScreen() {
            get(ref(db, 'game/scores')).then(snapshot => {
                const scores = snapshot.val() || {};
                const sortedTeams = Object.entries(scores)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3);
                
                if (sortedTeams.length >= 1) {
                    document.getElementById('firstTeamName').textContent = sortedTeams[0][0];
                    document.getElementById('firstTeamScore').textContent = sortedTeams[0][1];
                }
                
                if (sortedTeams.length >= 2) {
                    document.getElementById('secondTeamName').textContent = sortedTeams[1][0];
                    document.getElementById('secondTeamScore').textContent = sortedTeams[1][1];
                }
                
                if (sortedTeams.length >= 3) {
                    document.getElementById('thirdTeamName').textContent = sortedTeams[2][0];
                    document.getElementById('thirdTeamScore').textContent = sortedTeams[2][1];
                }
            });
        }

        function updateLobbyTeamsList() {
            get(ref(db, 'game/teams')).then(snapshot => {
                const teams = snapshot.val();
                const lobbyTeamsList = document.getElementById('lobbyTeamsList');
                
                if (teams) {
                    const teamNames = Object.keys(teams);
                    const teamsHtml = teamNames.map(teamName => `
                        <div class="team-card ${teamName === currentTeamName ? 'own-team' : ''}">
                            <div class="team-icon">üë•</div>
                            <div class="team-name-text">${teamName}</div>
                        </div>
                    `).join('');
                    
                    lobbyTeamsList.innerHTML = teamsHtml;
                } else {
                    lobbyTeamsList.innerHTML = '<p class="empty-state">Teams werden geladen...</p>';
                }
            });
        }

        function updateLeaderboardDisplay() {
            get(ref(db, 'game/scores')).then(snapshot => {
                const scores = snapshot.val() || {};
                const leaderboardDisplay = document.getElementById('leaderboardDisplay');
                
                if (Object.keys(scores).length === 0) {
                    leaderboardDisplay.innerHTML = '<p class="empty-state">Keine Teams bisher...</p>';
                    return;
                }
                
                const sortedTeams = Object.entries(scores)
                    .sort((a, b) => b[1] - a[1])
                    .map(([team, score], index) => {
                        const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                        const isOwnTeam = team === currentTeamName ? 'own-team' : '';
                        return `
                            <div class="scoreboard-entry ${isOwnTeam}">
                                <span class="medal">${medal}</span>
                                <span class="team-name">${team}</span>
                                <span class="team-score">${score} Punkte</span>
                            </div>
                        `;
                    }).join('');
                
                leaderboardDisplay.innerHTML = sortedTeams;
            });
        }

        window.voteAnswer = async function(questionId, teamName) {
            try {
                // Check if team already voted
                if (teamVote) {
                    alert('Du hast bereits abgestimmt!');
                    return;
                }
                
                // Store the vote
                await set(ref(db, `game/votes/${questionId}/${currentTeamName}`), teamName);
                
                // Increment vote count for the answer
                const voteRef = ref(db, `game/answers/${questionId}/${teamName}/votes`);
                await runTransaction(voteRef, (current) => {
                    return (current || 0) + 1;
                });
                
                teamVote = teamName;
                updateVotingDisplay();
            } catch (error) {
                console.error('Voting error:', error);
            }
        };

        async function submitAnswer() {
            const answerText = document.getElementById('answerInput').value.trim();
            if (!answerText) {
                alert('Bitte gib eine Antwort ein');
                return;
            }

            try {
                const questionRef = ref(db, 'game/currentQuestion');
                const snapshot = await get(questionRef);
                const question = snapshot.val();

                if (question) {
                    await set(ref(db, `game/answers/${question.id}/${currentTeamName}`), {
                        text: answerText,
                        votes: 0,
                        submittedAt: new Date().toISOString()
                    });

                    document.getElementById('answerInput').value = '';
                    document.getElementById('answerForm').style.display = 'none';
                    document.getElementById('answerSubmitted').style.display = 'block';
                }
            } catch (error) {
                console.error('Submit error:', error);
                alert('Fehler beim Einreichen der Antwort');
            }
        }

        function leaveGame() {
            currentTeamName = null;
            const loginScreen = document.getElementById('loginScreen');
            const gameScreen = document.getElementById('gameScreen');
            
            loginScreen.classList.add('active');
            loginScreen.style.display = 'block';
            gameScreen.classList.remove('active');
            gameScreen.style.display = 'none';
            document.getElementById('teamName').value = '';
        }
    </script>
</body>
</html>