<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nobody's Perfect - Spieler</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="screen active">
            <div class="login-box">
                <h1>üéÆ Nobody's Perfect</h1>
                <p class="subtitle">Spiel mit deinem Team mit!</p>
                <div id="setupBlockMessage" style="display:none; color:#ef4444; font-weight:bold; margin-bottom:15px;">Das Spiel wird gerade vorbereitet. Bitte warte, bis der Host das Spiel startet.</div>
                <div class="input-group">
                    <label for="teamName">Teamnamen:</label>
                    <input 
                        type="text" 
                        id="teamName" 
                        placeholder="z.B. Die Gewinner"
                        maxlength="20"
                    >
                </div>
                <button id="joinBtn" class="btn btn-primary">Spiel beitreten</button>
            </div>
        </div>

        <!-- Waiting Lobby Screen -->
        <div id="waitingLobbyScreen" class="screen">
            <div class="lobby-container">
                <h1 style="font-size: 2.8em;">‚è≥ Warten auf das Spiel</h1>
                <p style="font-size: 1.1em;">Der Host bereitet das Spiel vor...</p>
                
                <div class="waiting-teams-display">
                    <h3 style="font-size: 1.3em;">Beigetretene Teams:</h3>
                    <div id="lobbyTeamsList" class="teams-grid">
                        <p class="empty-state">Teams werden geladen...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="screen">
            <!-- Header with Score -->
            <header class="game-header">
                <div class="team-info">
                    <h2 id="currentTeam"></h2>
                    <div class="score-display">
                        <span id="teamScore">0</span> Punkte
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div id="timerDisplay" style="font-size: 1.5em; font-weight: bold; color: #10b981; display: none;">
                        ‚è±Ô∏è <span id="timerMinutes">0</span>:<span id="timerSeconds">00</span>
                    </div>
                </div>
            </header>

            <!-- Question Display -->
            <div class="question-section">
                <div id="questionArea" class="question-box">
                    <h3>Wartet auf Frage...</h3>
                </div>
            </div>

            <!-- Answer Input Section -->
            <div class="answer-section">
                <div id="answerForm" style="display: none;">
                    <h4>Deine Antwort:</h4>
                    <input 
                        type="text" 
                        id="answerInput" 
                        placeholder="Gib deine Antwort ein..."
                        maxlength="100"
                    >
                    <button id="submitAnswerBtn" class="btn btn-primary">Antwort einreichen</button>
                </div>
                <div id="answerSubmitted" style="display: none;" class="info-box">
                    ‚úì Deine Antwort wurde eingereicht
                </div>
            </div>

            <!-- Voting Section -->
            <div class="voting-section">
                <div class="voting-buttons">
                    <h4 style="margin-top: 0;">Abstimmen:</h4>
                    <div id="votingArea">
                        <p class="empty-state">Warte auf Antworten zum Abstimmen...</p>
                    </div>
                </div>
            </div>

            <!-- Scoreboard -->
            <div class="scoreboard-section">
                <div class="scoreboard">
                    <h4 style="margin-top: 0;">Punktestand:</h4>
                    <div id="scoreBoard">
                        <p class="empty-state">Keine Teams bisher...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transition Screen (Answer to Voting) -->
        <div id="transitionScreen" class="screen">
            <div class="transition-box" style="margin-top: 80px; padding: 20px;">
                <h1 style="font-size: 3em; margin-bottom: 40px; background: var(--card-bg); padding: 30px; border-radius: 12px; border: 1px solid var(--border-color);">‚è∏Ô∏è Antwortphase beendet</h1>
                <div style="background: var(--card-bg); padding: 50px; border-radius: 20px; max-width: 600px; margin: 0 auto; border: 1px solid var(--border-color);">
                    <h2 style="color: var(--text-color); font-size: 1.8em; margin-bottom: 15px; text-align: center;">Die Antworten sind eingegangen!</h2>
                    <p style="color: #cbd5e1; font-size: 1.1em; text-align: center; margin-bottom: 20px;">Alle Teams haben ihre Antworten eingereicht. Jetzt wird es spannend!</p>
                    <p style="color: #94a3b8; font-size: 1em; text-align: center;">Der Host startet gleich die Abstimmungsphase, wo ihr f√ºr die beste Antwort stimmen k√∂nnt.</p>
                </div>
            </div>
        </div>

        <!-- Time's Up Screen -->
        <div id="timesUpScreen" class="screen">
            <div class="transition-box" style="margin-top: 80px;">
                <h1 style="font-size: 3em; margin-bottom: 40px; background: var(--card-bg); padding: 30px; border-radius: 12px; border: 1px solid var(--border-color);">‚è±Ô∏è Die Zeit ist um!</h1>
                <div id="timesUpAnswerBox" style="padding: 50px; border-radius: 20px; max-width: 600px; margin: 0 auto; background: var(--card-bg); border: 1px solid var(--border-color);">
                    <!-- Answering Phase Display -->
                    <div id="timesUpAnswerContent" style="display: none; text-align: center;">
                        <p style="color: #cbd5e1; font-size: 0.95em; margin-bottom: 25px;">Deine Antwort:</p>
                        <p id="timesUpAnswerText" style="color: var(--text-color); font-size: 1.8em; font-weight: bold; text-align: center; background: rgba(0,0,0,0.25); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border-color);"></p>
                        <p style="color: #cbd5e1; font-size: 1.1em; text-align: center;">Der Host bereitet die n√§chste Phase vor...</p>
                    </div>
                    <!-- Voting Phase Display -->
                    <div id="timesUpVoteContent" style="display: none; text-align: center;">
                        <div id="timesUpVoteAnswerBox" style="background: rgba(0,0,0,0.25); padding: 30px; border-radius: 12px; margin-bottom: 25px; border: 1px solid var(--border-color);">
                            <p id="timesUpVoteIndicator" style="color: var(--primary-color); font-size: 2.5em; margin-bottom: 15px;"></p>
                            <p id="timesUpVoteText" style="color: var(--text-color); font-size: 2em; font-weight: bold; word-wrap: break-word;"></p>
                        </div>
                        <p id="timesUpVoteTeamName" style="color: #cbd5e1; font-size: 1.1em; margin-bottom: 20px;"></p>
                        <p style="color: #cbd5e1; font-size: 1.1em; text-align: center;">Der Host bereitet die n√§chste Phase vor...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leaderboard Screen -->
        <div id="leaderboardScreen" class="screen">
            <div class="leaderboard-container">
                <div class="leaderboard-header">
                    <h1>üèÜ Rangliste</h1>
                </div>
                <div class="leaderboard-content">
                    <div id="leaderboardDisplay" class="scoreboard">
                        <p class="empty-state">Lade Rangliste...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .transition-box {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            box-shadow: var(--shadow);
            max-width: 600px;
            margin: 0 auto;
        }

        .transition-box h1 {
            color: var(--text-color);
            font-size: 48px;
            margin-bottom: 20px;
        }

        .transition-box .subtitle {
            color: var(--text-secondary);
            font-size: 20px;
            margin-bottom: 40px;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 40px;
        }

        .spinner {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, set, update, onValue, child, get, runTransaction } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC85YAPrSD3a4uw-bzTOWWAx18KBG4Enes",
            authDomain: "w-feier.firebaseapp.com",
            databaseURL: "https://w-feier-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "w-feier",
            storageBucket: "w-feier.firebasestorage.app",
            messagingSenderId: "319969590062",
            appId: "1:319969590062:web:7601a072a2429df53758bf",
            measurementId: "G-C7KVSD61MF"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let currentTeamName = null;
        let currentUser = null;
        let roundFinished = false;
        let currentQuestion = null;
        let teamVote = null; // Track which answer this team voted for (team name)
        let teamVoteData = null; // Track full vote data (team name, answer text, is correct)
        let teamAnswer = null; // Track the current answer submitted by this team
        let gamePhase = 'setup'; // Syncs with host: 'setup', 'answering', 'voting', 'finished'
        let timerExpired = false; // Track if timer has expired
        
        // Timer variables
        let timerInterval = null;
        let timerRemaining = 0;
        let timerStartTime = null;

        // Anonymous sign-in
        signInAnonymously(auth)
            .then(user => {
                currentUser = user;
                console.log("Authenticated as:", user.user.uid);
                // After authentication, check if team has a saved session
                checkAndRestoreSession();
            })
            .catch(error => console.error("Auth error:", error));

        // Check if team has a saved session in localStorage
        function checkAndRestoreSession() {
            const savedTeamName = localStorage.getItem('wfeier_teamName');
            if (savedTeamName) {
                // Verify the team still exists in the game
                get(ref(db, `game/teams/${savedTeamName}`)).then(snapshot => {
                    if (snapshot.exists()) {
                        // Team exists in game, restore the session
                        currentTeamName = savedTeamName;
                        console.log('‚úì Session restored for team:', currentTeamName);
                        showGameScreen();
                        startListeners();
                    } else {
                        // Team doesn't exist in game, clear saved session
                        localStorage.removeItem('wfeier_teamName');
                    }
                }).catch(error => {
                    console.error('Error checking team session:', error);
                    localStorage.removeItem('wfeier_teamName');
                });
            }
        }

        // Timer Functions
        function startTimer(duration) {
            // Stop any existing timer
            stopTimer();
            
            timerRemaining = duration;
            timerStartTime = Date.now();
            
            // Show timer display
            const timerDisplay = document.getElementById('timerDisplay');
            if (timerDisplay) timerDisplay.style.display = 'flex';
            
            // Update display immediately
            updateTimerDisplay();
            
            // Update timer every 100ms for smooth countdown
            timerInterval = setInterval(updateTimerDisplay, 100);
        }

        function updateTimerDisplay() {
            if (timerStartTime === null) return;
            
            const elapsedMs = Date.now() - timerStartTime;
            const remaining = Math.max(0, timerRemaining - Math.floor(elapsedMs / 1000));
            
            const minutes = Math.floor(remaining / 60);
            const seconds = remaining % 60;
            
            const timerMinutesEl = document.getElementById('timerMinutes');
            const timerSecondsEl = document.getElementById('timerSeconds');
            if (timerMinutesEl) {
                timerMinutesEl.textContent = minutes;
            }
            if (timerSecondsEl) {
                timerSecondsEl.textContent = seconds.toString().padStart(2, '0');
            }
            
            // Change color as time runs out
            const timerDisplay = document.getElementById('timerDisplay');
            if (timerDisplay) {
                if (remaining <= 10) {
                    timerDisplay.style.color = '#ef4444'; // Red
                } else if (remaining <= 20) {
                    timerDisplay.style.color = '#f97316'; // Orange
                } else {
                    timerDisplay.style.color = '#10b981'; // Green
                }
            }
            
            // When timer reaches 0
            if (remaining <= 0) {
                stopTimer();
                handleTimerExpired();
            }
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            const timerDisplay = document.getElementById('timerDisplay');
            if (timerDisplay) timerDisplay.style.display = 'none';
        }

        async function handleTimerExpired() {
            console.log('‚è±Ô∏è Timer expired for phase:', gamePhase);
            timerExpired = true;
            
            // Auto-submit answer if in answering phase and text exists
            if (gamePhase === 'answering') {
                const answerInput = document.getElementById('answerInput');
                if (answerInput && answerInput.value.trim()) {
                    console.log('Auto-submitting answer:', answerInput.value.trim());
                    await submitAnswer(true);
                }
            }
            
            // Show the times up screen
            const timesUpScreen = document.getElementById('timesUpScreen');
            const gameScreen = document.getElementById('gameScreen');
            const timesUpAnswerBox = document.getElementById('timesUpAnswerBox');
            
            if (timesUpScreen && gameScreen && timesUpAnswerBox) {
                gameScreen.classList.remove('active');
                timesUpScreen.classList.add('active');
                
                // Show submitted answer if in answering phase
                const timesUpAnswerContent = document.getElementById('timesUpAnswerContent');
                if (gamePhase === 'answering') {
                    if (teamAnswer) {
                        timesUpAnswerContent.style.display = 'block';
                        document.getElementById('timesUpVoteContent').style.display = 'none';
                        document.getElementById('timesUpAnswerText').textContent = teamAnswer;
                        timesUpAnswerBox.style.background = 'linear-gradient(135deg, #f97316 0%, #dc2626 100%)';
                    } else {
                        // Show message when no answer was submitted
                        timesUpAnswerContent.style.display = 'block';
                        document.getElementById('timesUpVoteContent').style.display = 'none';
                        document.getElementById('timesUpAnswerText').innerHTML = '‚ùå Keine Antwort eingereicht';
                        timesUpAnswerBox.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                    }
                } else if (gamePhase === 'voting' && teamVoteData) {
                    // Show selected vote if in voting phase
                    const timesUpVoteContent = document.getElementById('timesUpVoteContent');
                    const voteIndicatorEl = document.getElementById('timesUpVoteIndicator');
                    const voteTextEl = document.getElementById('timesUpVoteText');
                    const voteTeamNameEl = document.getElementById('timesUpVoteTeamName');
                    
                    timesUpAnswerContent.style.display = 'none';
                    timesUpVoteContent.style.display = 'block';
                    
                    // Set background color based on correct/wrong
                    if (teamVoteData.isCorrect) {
                        voteIndicatorEl.textContent = '‚úì';
                        voteIndicatorEl.style.color = '#86efac'; // Green
                        timesUpAnswerBox.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                        voteTeamNameEl.textContent = '';
                    } else {
                        voteIndicatorEl.textContent = '‚úó';
                        voteIndicatorEl.style.color = '#fca5a5'; // Light red
                        timesUpAnswerBox.style.background = 'linear-gradient(135deg, #f97316 0%, #dc2626 100%)';
                        voteTeamNameEl.innerHTML = `<strong>Antwort von Team ${teamVoteData.teamName}</strong>`;
                    }
                    
                    voteTextEl.textContent = teamVoteData.answerText;
                } else if (gamePhase === 'voting') {
                    // No vote submitted in voting phase
                    timesUpAnswerContent.style.display = 'block';
                    document.getElementById('timesUpVoteContent').style.display = 'none';
                    document.getElementById('timesUpAnswerText').innerHTML = '‚ùå Keine Abstimmung abgegeben';
                    timesUpAnswerBox.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                } else {
                    timesUpAnswerContent.style.display = 'none';
                    document.getElementById('timesUpVoteContent').style.display = 'none';
                }
            }
        }

        // Event Listeners
        document.getElementById('joinBtn').addEventListener('click', joinGame);
        document.getElementById('submitAnswerBtn').addEventListener('click', submitAnswer);

        async function joinGame() {
            // Only allow joining if phase is 'waiting_for_teams'
            const phaseSnapshot = await get(ref(db, 'game/phase'));
            const phase = phaseSnapshot.val();
            if (phase !== 'waiting_for_teams') {
                alert('Das Spiel ist noch nicht f√ºr Teams ge√∂ffnet oder l√§uft bereits. Bitte warte, bis der Host das Spiel f√ºr Teams freigibt.');
                return;
            }
            const teamName = document.getElementById('teamName').value.trim();
            if (!teamName) {
                alert('Bitte gib einen Teamnamen ein');
                return;
            }
            currentTeamName = teamName;
            // Save team name to localStorage for session persistence
            localStorage.setItem('wfeier_teamName', teamName);
            // Create team in database
            await set(ref(db, `game/teams/${teamName}`), {
                name: teamName,
                joinedAt: new Date().toISOString()
            });
            // Initialize score if not exists
            const scoreRef = ref(db, `game/scores/${teamName}`);
            const snapshot = await get(scoreRef);
            if (!snapshot.exists()) {
                await set(scoreRef, 0);
            }
            showGameScreen();
            startListeners();
        }

        function resetToLogin() {
            const loginScreen = document.getElementById('loginScreen');
            const gameScreen = document.getElementById('gameScreen');
            const waitingLobbyScreen = document.getElementById('waitingLobbyScreen');
            const leaderboardScreen = document.getElementById('leaderboardScreen');
            const transitionScreen = document.getElementById('transitionScreen');
            
            // Reset team name
            currentTeamName = null;
            gamePhase = 'setup';
            
            // Clear input
            document.getElementById('teamName').value = '';
            
            // Show login screen, hide all others
            loginScreen.classList.add('active');
            gameScreen.classList.remove('active');
            waitingLobbyScreen.classList.remove('active');
            leaderboardScreen.classList.remove('active');
            transitionScreen.classList.remove('active');
        }

        function updateVotingDisplay() {
            const votingArea = document.getElementById('votingArea');
            
            // Check if round is finished first
            if (!roundFinished || !currentQuestion) {
                votingArea.innerHTML = '<p class="empty-state">Warte auf Freigabe der Antworten...</p>';
                return;
            }
            
                    // Get the game seed first
                    get(ref(db, 'game/seed')).then(seedSnapshot => {
                        const gameSeed = seedSnapshot.val() || '';
                        // Get all answers from database
                        get(ref(db, 'game/answers')).then(snapshot => {
                            const allAnswers = snapshot.val();
                            // Check if team already voted
                            get(ref(db, `game/votes/${currentQuestion.id}/${currentTeamName}`)).then(voteSnapshot => {
                                teamVote = voteSnapshot.val();
                                
                                // If team voted, restore the vote data for display after page refresh
                                if (teamVote && allAnswers && allAnswers[currentQuestion.id] && allAnswers[currentQuestion.id][teamVote]) {
                                    const answerData = allAnswers[currentQuestion.id][teamVote];
                                    const isCorrect = teamVote === 'L√∂sung' || (currentQuestion && answerData.text === currentQuestion.correct);
                                    teamVoteData = {
                                        teamName: teamVote,
                                        answerText: answerData.text,
                                        isCorrect: isCorrect
                                    };
                                }
                                
                                if (allAnswers && allAnswers[currentQuestion.id]) {
                                    let votingHtml = '';
                                    const teamAnswers = allAnswers[currentQuestion.id];
                                    // Convert to array and filter out own answer
                                    let answerArr = Object.entries(teamAnswers).filter(([team]) => team !== currentTeamName);
                                    // Seeded shuffle: use game seed + team name + question id as seed
                                    function seededRandom(seed) {
                                        let x = Math.sin(seed) * 10000;
                                        return x - Math.floor(x);
                                    }
                                    function stringToSeed(str) {
                                        let hash = 0;
                                        for (let i = 0; i < str.length; i++) {
                                            hash = ((hash << 5) - hash) + str.charCodeAt(i);
                                            hash |= 0;
                                        }
                                        return Math.abs(hash);
                                    }
                                    function seededShuffle(array, seed) {
                                        let arr = array.slice();
                                        for (let i = arr.length - 1; i > 0; i--) {
                                            const j = Math.floor(seededRandom(seed + i) * (i + 1));
                                            [arr[i], arr[j]] = [arr[j], arr[i]];
                                        }
                                        return arr;
                                    }
                                    const seed = stringToSeed(gameSeed + '_' + currentTeamName + '_' + currentQuestion.id);
                                    answerArr = seededShuffle(answerArr, seed);
                                    answerArr.forEach(([team, answerData]) => {
                                        const isVoted = teamVote === team;
                                        const buttonClass = isVoted ? 'btn-vote-selected' : '';
                                        const checkmark = isVoted ? '‚úì ' : '';
                                        votingHtml += `
                                            <div class="voting-button">
                                                <button class="btn btn-vote ${buttonClass}" onclick="voteAnswer('${currentQuestion.id}', '${team}')" ${teamVote ? 'disabled' : ''}>
                                                    ${checkmark}${answerData.text}
                                                </button>
                                            </div>
                                        `;
                                    });
                                    votingArea.innerHTML = votingHtml || '<p class="empty-state">Nur deine Antwort verf√ºgbar</p>';
                                } else {
                                    votingArea.innerHTML = '<p class="empty-state">Warte auf Antworten zum Abstimmen...</p>';
                                }
                            });
                        });
                    });
        }

        function showGameScreen() {
            const loginScreen = document.getElementById('loginScreen');
            const gameScreen = document.getElementById('gameScreen');
            
            loginScreen.classList.remove('active');
            gameScreen.classList.add('active');
            document.getElementById('currentTeam').textContent = `Team: ${currentTeamName}`;
        }

        let previousPhase = 'setup';

        function startListeners() {
            // Listen for game phase
            onValue(ref(db, 'game/phase'), (snapshot) => {
                const newPhase = snapshot.val();
                // Show/hide join button and message on login screen
                const joinBtn = document.getElementById('joinBtn');
                const setupBlockMessage = document.getElementById('setupBlockMessage');
                if (newPhase !== 'waiting_for_teams') {
                    joinBtn.disabled = true;
                    setupBlockMessage.style.display = 'block';
                    setupBlockMessage.textContent = (newPhase === 'setup')
                        ? 'Das Spiel wird gerade vorbereitet. Bitte warte, bis der Host das Spiel startet.'
                        : 'Das Spiel ist bereits gestartet oder l√§uft. Bitte warte auf die n√§chste Runde.';
                } else {
                    joinBtn.disabled = false;
                    setupBlockMessage.style.display = 'none';
                }
                if (newPhase !== gamePhase) {
                    previousPhase = gamePhase;
                    gamePhase = newPhase;
                    console.log('üîÑ Game phase changed to:', gamePhase);
                    
                    // Reset timerExpired when starting a new timed phase to prevent flashing old screens
                    if (gamePhase === 'answering' || gamePhase === 'voting') {
                        timerExpired = false;
                        const timesUpScreen = document.getElementById('timesUpScreen');
                        if (timesUpScreen) timesUpScreen.classList.remove('active');
                    }

                    // Stop timer if phase ended early (e.g., answering -> answering_finished)
                    // Don't change the UI, just stop the countdown
                    if ((previousPhase === 'answering' || previousPhase === 'voting') && 
                        (gamePhase === 'answering_finished' || gamePhase === 'voting' || gamePhase === 'results')) {
                        stopTimer();
                    } else {
                        // Timer will be started when question data is received for new phases
                        updateUIForPhase();
                    }
                } else if ((gamePhase === 'answering' || gamePhase === 'voting') && currentQuestion && currentQuestion.timerStartTime) {
                    // Restore timer from server data if question has timer info
                    const now = Math.floor(Date.now() / 1000);
                    const elapsedSeconds = now - currentQuestion.timerStartTime;
                    const remainingSeconds = Math.max(0, currentQuestion.timerDuration - elapsedSeconds);
                    
                    if (remainingSeconds > 0) {
                        startTimer(remainingSeconds);
                    } else {
                        handleTimerExpired();
                    }
                }
            });

            // Listen for current question
            onValue(ref(db, 'game/currentQuestion'), (snapshot) => {
                currentQuestion = snapshot.val();
                const question = currentQuestion;
                const questionArea = document.getElementById('questionArea');
                
                // Reset vote and answer for new question
                teamVote = null;
                teamVoteData = null;
                teamAnswer = null;
                timerExpired = false;
                
                // Hide timesUpScreen when new question arrives
                const timesUpScreen = document.getElementById('timesUpScreen');
                const gameScreen = document.getElementById('gameScreen');
                if (timesUpScreen && gameScreen) {
                    timesUpScreen.classList.remove('active');
                    gameScreen.classList.add('active');
                }
                
                if (question) {
                    questionArea.innerHTML = `<h3>${question.text}</h3>`;
                    
                    // Start timer if question has timer data and we're in answering/voting phase
                    if ((gamePhase === 'answering' || gamePhase === 'voting') && question.timerStartTime && question.timerDuration) {
                        const now = Math.floor(Date.now() / 1000);
                        const elapsedSeconds = now - question.timerStartTime;
                        const remainingSeconds = Math.max(0, question.timerDuration - elapsedSeconds);
                        
                        if (remainingSeconds > 0) {
                            startTimer(remainingSeconds);
                        } else {
                            handleTimerExpired();
                        }
                    }
                    
                    // Only show answer form during answering phase
                    if (gamePhase === 'answering') {
                        // Check if team already answered
                        const answerRef = ref(db, `game/answers/${question.id}/${currentTeamName}`);
                        get(answerRef).then(snap => {
                            if (snap.exists()) {
                                const answerData = snap.val();
                                teamAnswer = answerData.text; // Set the variable to maintain state after refresh
                                document.getElementById('answerForm').style.display = 'none';
                                document.getElementById('answerSubmitted').style.display = 'block';
                            } else {
                                teamAnswer = null; // Clear if no answer found
                                document.getElementById('answerForm').style.display = 'block';
                                document.getElementById('answerSubmitted').style.display = 'none';
                            }
                        });
                    } else {
                        // During voting or other phases, never show the answer form
                        document.getElementById('answerForm').style.display = 'none';
                        document.getElementById('answerSubmitted').style.display = 'none';
                    }
                } else {
                    questionArea.innerHTML = '<h3>Wartet auf Frage...</h3>';
                    document.getElementById('answerForm').style.display = 'none';
                    document.getElementById('answerSubmitted').style.display = 'none';
                    stopTimer();
                }
                
                // Update voting display when question changes
                updateVotingDisplay();
            });

            // Listen for answers (voting)
            onValue(ref(db, 'game/answers'), (snapshot) => {
                updateVotingDisplay();
            });
            
            // Listen for round finished state to trigger voting display update
            onValue(ref(db, 'game/roundFinished'), (snapshot) => {
                roundFinished = snapshot.val() || false;
                updateVotingDisplay();
            });

            // Listen for scores
            onValue(ref(db, 'game/scores'), (snapshot) => {
                const scores = snapshot.val();
                const scoreBoard = document.getElementById('scoreBoard');
                
                if (scores) {
                    const sortedTeams = Object.entries(scores)
                        .sort((a, b) => b[1] - a[1])
                        .map(([team, score]) => `
                            <div class="scoreboard-entry ${team === currentTeamName ? 'own-team' : ''}">
                                <span class="team-name">${team}</span>
                                <span class="team-score">${score}</span>
                            </div>
                        `).join('');
                    scoreBoard.innerHTML = sortedTeams;
                } else {
                    scoreBoard.innerHTML = '<p class="empty-state">Keine Teams bisher...</p>';
                }

                // Update own score
                if (scores && scores[currentTeamName]) {
                    document.getElementById('teamScore').textContent = scores[currentTeamName];
                }
            });

            // Listen for game phase
            onValue(ref(db, 'game/phase'), (snapshot) => {
                gamePhase = snapshot.val() || 'setup';
                updateUIForPhase();
            });

            // Listen for teams joining (for lobby display)
            onValue(ref(db, 'game/teams'), (snapshot) => {
                updateLobbyTeamsList();
            });
        }

        function updateUIForPhase() {
            const gameScreen = document.getElementById('gameScreen');
            const transitionScreen = document.getElementById('transitionScreen');
            const leaderboardScreen = document.getElementById('leaderboardScreen');
            const waitingLobbyScreen = document.getElementById('waitingLobbyScreen');
            const answerForm = document.getElementById('answerForm');
            const answerSubmitted = document.getElementById('answerSubmitted');
            const votingSection = document.querySelector('.voting-section');
            const submitBtn = document.getElementById('submitAnswerBtn');
            
            if (gamePhase === 'setup' || gamePhase === 'waiting_for_teams') {
                // Show waiting lobby screen during setup or waiting_for_teams
                gameScreen.classList.remove('active');
                transitionScreen.classList.remove('active');
                leaderboardScreen.classList.remove('active');
                waitingLobbyScreen.classList.add('active');
                updateLobbyTeamsList();
            } else {
                // If moving away from setup/waiting_for_teams phase, verify team is actually in the game
                if (currentTeamName && gamePhase !== 'setup' && gamePhase !== 'waiting_for_teams') {
                    get(ref(db, `game/teams/${currentTeamName}`)).then(snapshot => {
                        if (!snapshot.exists()) {
                            // Team is not in the game - send them back to login
                            console.log('Team not found in game, redirecting to login');
                            resetToLogin();
                            return;
                        }
                        // Team exists, proceed with normal UI update
                        updateUIForPhaseHelper(gameScreen, transitionScreen, leaderboardScreen, 
                                             waitingLobbyScreen, answerForm, answerSubmitted, votingSection, submitBtn);
                    }).catch(error => {
                        console.error('Error checking team:', error);
                        resetToLogin();
                    });
                } else {
                    // No team or already checked, proceed with normal UI update
                    updateUIForPhaseHelper(gameScreen, transitionScreen, leaderboardScreen, 
                                         waitingLobbyScreen, answerForm, answerSubmitted, votingSection, submitBtn);
                }
            }
        }
        
        function updateUIForPhaseHelper(gameScreen, transitionScreen, leaderboardScreen,
                                       waitingLobbyScreen, answerForm, answerSubmitted, votingSection, submitBtn) {
            const timesUpScreen = document.getElementById('timesUpScreen');
            const scoreboardSection = document.querySelector('.scoreboard-section');
            
            if (gamePhase === 'answering') {
                // Show game screen with answer section, hide voting and leaderboard
                // If timer has expired, show timesUpScreen instead
                if (timerExpired) {
                    gameScreen.classList.remove('active');
                    if (timesUpScreen) timesUpScreen.classList.add('active');
                } else {
                    gameScreen.classList.add('active');
                    if (timesUpScreen) timesUpScreen.classList.remove('active');
                }
                transitionScreen.classList.remove('active');
                leaderboardScreen.classList.remove('active');
                waitingLobbyScreen.classList.remove('active');
                votingSection.style.display = 'none';
                scoreboardSection.classList.remove('show');
                answerForm.style.display = 'block';
                answerSubmitted.style.display = 'none';
                if (submitBtn) submitBtn.disabled = false;
            } else if (gamePhase === 'answering_finished') {
                // Show transition screen
                gameScreen.classList.remove('active');
                if (timesUpScreen) timesUpScreen.classList.remove('active');
                transitionScreen.classList.add('active');
                leaderboardScreen.classList.remove('active');
                waitingLobbyScreen.classList.remove('active');
            } else if (gamePhase === 'voting') {
                // Show game screen with voting section, hide answer input
                // If timer has expired, show timesUpScreen instead
                if (timerExpired) {
                    gameScreen.classList.remove('active');
                    if (timesUpScreen) timesUpScreen.classList.add('active');
                } else {
                    gameScreen.classList.add('active');
                    if (timesUpScreen) timesUpScreen.classList.remove('active');
                }
                transitionScreen.classList.remove('active');
                leaderboardScreen.classList.remove('active');
                waitingLobbyScreen.classList.remove('active');
                votingSection.style.display = 'block';
                scoreboardSection.classList.add('show');
                answerForm.style.display = 'none';
                answerSubmitted.style.display = 'none';
                if (submitBtn) submitBtn.disabled = true;  // Disable answer submission
            } else if (gamePhase === 'results') {
                // Show leaderboard screen
                gameScreen.classList.remove('active');
                if (timesUpScreen) timesUpScreen.classList.remove('active');
                transitionScreen.classList.remove('active');
                leaderboardScreen.classList.add('active');
                waitingLobbyScreen.classList.remove('active');
                updateLeaderboardDisplay();
            } else if (gamePhase === 'celebration') {
                // Navigate to celebration screen
                window.location.href = 'celebration.html';
            } else {
                // Finished phase
                gameScreen.classList.add('active');
                transitionScreen.classList.remove('active');
                leaderboardScreen.classList.remove('active');
                waitingLobbyScreen.classList.remove('active');
                votingSection.style.display = 'none';
                scoreboardSection.classList.remove('show');
                answerForm.style.display = 'none';
                if (submitBtn) submitBtn.disabled = true;
            }
        }

        function updateLobbyTeamsList() {
            get(ref(db, 'game/teams')).then(snapshot => {
                const teams = snapshot.val();
                const lobbyTeamsList = document.getElementById('lobbyTeamsList');
                
                if (teams) {
                    const teamNames = Object.keys(teams);
                    const teamsHtml = teamNames.map(teamName => `
                        <div class="team-card ${teamName === currentTeamName ? 'own-team' : ''}">
                            <div class="team-icon">üë•</div>
                            <div class="team-name-text">${teamName}</div>
                        </div>
                    `).join('');
                    
                    lobbyTeamsList.innerHTML = teamsHtml;
                } else {
                    lobbyTeamsList.innerHTML = '<p class="empty-state">Teams werden geladen...</p>';
                }
            });
        }

        function updateLeaderboardDisplay() {
            get(ref(db, 'game/scores')).then(snapshot => {
                const scores = snapshot.val() || {};
                const leaderboardDisplay = document.getElementById('leaderboardDisplay');
                
                if (Object.keys(scores).length === 0) {
                    leaderboardDisplay.innerHTML = '<p class="empty-state">Keine Teams bisher...</p>';
                    return;
                }
                
                const sortedTeams = Object.entries(scores)
                    .sort((a, b) => b[1] - a[1])
                    .map(([team, score], index) => {
                        const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                        const isOwnTeam = team === currentTeamName ? 'own-team' : '';
                        return `
                            <div class="scoreboard-entry ${isOwnTeam}">
                                <span class="medal">${medal}</span>
                                <span class="team-name">${team}</span>
                                <span class="team-score">${score} Punkte</span>
                            </div>
                        `;
                    }).join('');
                
                leaderboardDisplay.innerHTML = sortedTeams;
            });
        }

        window.voteAnswer = async function(questionId, teamName) {
            try {
                // Check if team already voted
                if (teamVote) {
                    alert('Du hast bereits abgestimmt!');
                    return;
                }
                
                // Get the answer data to display
                const answerRef = ref(db, `game/answers/${questionId}/${teamName}`);
                const answerSnapshot = await get(answerRef);
                const answerData = answerSnapshot.val();
                
                // Store the vote
                await set(ref(db, `game/votes/${questionId}/${currentTeamName}`), teamName);
                
                // Increment vote count for the answer
                const voteRef = ref(db, `game/answers/${questionId}/${teamName}/votes`);
                await runTransaction(voteRef, (current) => {
                    return (current || 0) + 1;
                });
                
                teamVote = teamName;
                
                // Store full vote data for display
                if (answerData) {
                    const isCorrect = teamName === 'L√∂sung' || (currentQuestion && answerData.text === currentQuestion.correct);
                    teamVoteData = {
                        teamName: teamName,
                        answerText: answerData.text,
                        isCorrect: isCorrect
                    };
                }
                
                updateVotingDisplay();
            } catch (error) {
                console.error('Voting error:', error);
            }
        };

        async function submitAnswer(isAutoSubmit = false) {
            const answerText = document.getElementById('answerInput').value.trim();
            if (!answerText) {
                if (!isAutoSubmit) {
                    alert('Bitte gib eine Antwort ein');
                }
                return;
            }

            try {
                const questionRef = ref(db, 'game/currentQuestion');
                const snapshot = await get(questionRef);
                const question = snapshot.val();

                if (!question) {
                    if (!isAutoSubmit) {
                        alert('Keine aktive Frage - bitte warte auf die n√§chste Frage');
                    }
                    return;
                }

                // Check if answer window is still open by comparing current time with timer
                const now = Math.floor(Date.now() / 1000);
                const elapsedSeconds = now - question.timerStartTime;
                const remainingSeconds = question.timerDuration - elapsedSeconds;

                if (remainingSeconds <= 0 && !isAutoSubmit) {
                    alert('Die Zeit zum Beantworten ist abgelaufen!');
                    return;
                }

                // Store answer in local variable for display
                teamAnswer = answerText;
                
                await set(ref(db, `game/answers/${question.id}/${currentTeamName}`), {
                    text: answerText,
                    votes: 0,
                    submittedAt: new Date().toISOString()
                });

                document.getElementById('answerInput').value = '';
                document.getElementById('answerForm').style.display = 'none';
                document.getElementById('answerSubmitted').style.display = 'block';
            } catch (error) {
                console.error('Submit error:', error);
                alert('Fehler beim Einreichen der Antwort');
            }
        }

        function leaveGame() {
            currentTeamName = null;
            // Clear saved session from localStorage
            localStorage.removeItem('wfeier_teamName');
            const loginScreen = document.getElementById('loginScreen');
            const gameScreen = document.getElementById('gameScreen');
            
            loginScreen.classList.add('active');
            loginScreen.style.display = 'block';
            gameScreen.classList.remove('active');
            gameScreen.style.display = 'none';
            document.getElementById('teamName').value = '';
        }
    </script>
</body>
</html>